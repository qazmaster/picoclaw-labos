---
name: test-driven-development
description: "TDD: тест → падает → код → проходит → рефакторинг. Используй при любой реализации. Триггеры: 'TDD', 'напиши тест', 'test first', 'red green refactor'."
---

# Test-Driven Development (TDD)

## Обзор

Сначала тест. Смотри как падает. Минимальный код для прохождения.

**Принцип:** Если не видел как тест падает — не знаешь, тестирует ли он правильное.

## Iron Law

```
НЕТ ПРОДАКШН КОДА БЕЗ FALLING TEST
```

Написал код до теста? Удали. Начни заново.

**Без исключений:**

- Не оставляй как "reference"
- Не "адаптируй" при написании тестов
- Удалить = удалить

## Red-Green-Refactor

### RED — Напиши failing test

Один минимальный тест, показывающий что должно произойти.

```typescript
test("retries failed operations 3 times", async () => {
  let attempts = 0;
  const operation = () => {
    attempts++;
    if (attempts < 3) throw new Error("fail");
    return "success";
  };

  const result = await retryOperation(operation);

  expect(result).toBe("success");
  expect(attempts).toBe(3);
});
```

**Требования:**

- Одно поведение
- Понятное имя
- Реальный код (моки только если неизбежно)

### Verify RED — Смотри как падает

**ОБЯЗАТЕЛЬНО. Никогда не пропускай.**

```bash
npm test path/to/test.test.ts
```

Убедись:

- Тест падает (не error)
- Сообщение ожидаемое
- Падает потому что фича отсутствует

**Тест проходит?** Тестируешь существующее. Исправь тест.

### GREEN — Минимальный код

Простейший код для прохождения теста.

```typescript
async function retryOperation<T>(fn: () => Promise<T>): Promise<T> {
  for (let i = 0; i < 3; i++) {
    try {
      return await fn();
    } catch (e) {
      if (i === 2) throw e;
    }
  }
  throw new Error("unreachable");
}
```

Не добавляй фичи, не рефактори другой код.

### Verify GREEN — Смотри как проходит

**ОБЯЗАТЕЛЬНО.**

```bash
npm test path/to/test.test.ts
```

Убедись:

- Тест проходит
- Другие тесты не сломались
- Output чистый

### REFACTOR — Улучши

После green:

- Убери дублирование
- Улучши имена
- Извлеки helpers

Тесты остаются green. Не добавляй поведение.

## Рационализации (отмазки)

| Отмазка                    | Реальность                                             |
| -------------------------- | ------------------------------------------------------ |
| "Слишком просто для теста" | Простой код ломается. Тест занимает 30 секунд.         |
| "Тесты напишу потом"       | Тесты, проходящие сразу, ничего не доказывают.         |
| "Уже вручную проверил"     | Ad-hoc ≠ systematic. Нет записи, нельзя перезапустить. |
| "TDD замедлит"             | TDD быстрее дебага.                                    |

## Verification Checklist

Перед завершением:

- [ ] Каждая функция имеет тест
- [ ] Видел как каждый тест падает
- [ ] Падал по ожидаемой причине
- [ ] Минимальный код для каждого теста
- [ ] Все тесты проходят
- [ ] Output чистый
- [ ] Тесты используют реальный код
- [ ] Edge cases покрыты

## Связанные скиллы

- `subagent-driven-development` → использует TDD
- `systematic-debugging` → failing test для бага
- `writing-plans` → планы включают TDD шаги
